{% extends "base.html" %}

{% block title %}ê²Œì‹œê¸€ ìˆ˜ì • - {{ board.name }} - BO System{% endblock %}

{% block extra_styles %}
<link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">
<style>
  .form-container {
    background: white;
    padding: 30px;
    border-radius: 10px;
    box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
  }

  .form-group {
    margin-bottom: 20px;
  }

  .form-group label {
    display: block;
    margin-bottom: 8px;
    font-weight: bold;
    color: #2c3e50;
  }

  .form-group input {
    width: 100%;
    padding: 12px;
    border: 1px solid #ddd;
    border-radius: 4px;
    font-size: 14px;
    box-sizing: border-box;
  }

  /* Quill ì—ë””í„° ìŠ¤íƒ€ì¼ */
  #editor {
    min-height: 300px;
    background: white;
  }

  .ql-container {
    font-size: 14px;
    font-family: inherit;
  }

  .btn-group {
    display: flex;
    gap: 10px;
    justify-content: flex-end;
    margin-top: 20px;
  }

  .btn-cancel {
    padding: 10px 20px;
    background: #95a5a6;
    color: white;
    border: none;
    border-radius: 4px;
    cursor: pointer;
    text-decoration: none;
    display: inline-block;
  }

  .btn-submit {
    padding: 10px 20px;
    background: #3498db;
    color: white;
    border: none;
    border-radius: 4px;
    cursor: pointer;
    font-weight: bold;
  }

  .btn-cancel:hover {
    background: #7f8c8d;
  }

  .btn-submit:hover {
    background: #2980b9;
  }

  .board-info {
    background: #f8f9fa;
    padding: 15px;
    border-radius: 4px;
    margin-bottom: 20px;
  }

  /* íŒŒì¼ ì²¨ë¶€ ì˜ì—­ */
  .file-upload-area {
    border: 2px dashed #ddd;
    border-radius: 4px;
    padding: 20px;
    text-align: center;
    background: #fafafa;
    cursor: pointer;
    transition: all 0.3s;
  }

  .file-upload-area:hover {
    border-color: #3498db;
    background: #f0f8ff;
  }

  .file-upload-area.dragover {
    border-color: #3498db;
    background: #e8f4fd;
  }

  .file-list {
    margin-top: 15px;
    padding: 10px;
    background: #f8f9fa;
    border-radius: 4px;
  }

  .file-item {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 8px;
    margin: 5px 0;
    background: white;
    border-radius: 4px;
    border: 1px solid #ddd;
  }

  .file-item-name {
    flex: 1;
    font-size: 14px;
    color: #333;
  }

  .file-item-remove {
    background: #e74c3c;
    color: white;
    border: none;
    border-radius: 3px;
    padding: 4px 10px;
    cursor: pointer;
    font-size: 12px;
  }

  .file-item-remove:hover {
    background: #c0392b;
  }

  .file-input-hidden {
    display: none;
  }
</style>
{% endblock %}

{% block content %}
<a href="/admin/board/{{ board.id }}/post/{{ post.id }}" class="btn-back">â† ê²Œì‹œê¸€ ë³´ê¸°ë¡œ</a>

<div class="form-container">
  <div class="board-info">
    <strong>ê²Œì‹œíŒ:</strong> {{ board.name }} ({{ board.id }})
  </div>

  <h2 style="margin-top: 0">âœï¸ ê²Œì‹œê¸€ ìˆ˜ì •</h2>

  <form id="postForm" action="/admin/board/{{ board.id }}/post/{{ post.id }}/edit" method="post" enctype="multipart/form-data">
    <div class="form-group">
      <label for="title">ì œëª© *</label>
      <input
        type="text"
        id="title"
        name="title"
        value="{{ post.title }}"
        required
        maxlength="255"
      />
    </div>

    <div class="form-group">
      <label for="content">ë‚´ìš© *</label>
      <div id="editor"></div>
      <textarea id="content" name="content" style="display: none;"></textarea>
    </div>

    <div class="form-group">
      <label>íŒŒì¼ ì²¨ë¶€</label>
      <div class="file-upload-area" id="fileUploadArea">
        <p style="margin: 0; color: #666;">ğŸ“ íŒŒì¼ì„ ë“œë˜ê·¸í•˜ê±°ë‚˜ í´ë¦­í•˜ì—¬ ì²¨ë¶€í•˜ì„¸ìš”</p>
        <input type="file" id="fileInput" name="files" multiple class="file-input-hidden" accept="image/*,.pdf,.doc,.docx,.xls,.xlsx,.txt,.zip">
      </div>
      <div class="file-list" id="fileList" style="display: none;"></div>
    </div>

    <div class="btn-group">
      <a href="/admin/board/{{ board.id }}/post/{{ post.id }}" class="btn-cancel">ì·¨ì†Œ</a>
      <button type="submit" class="btn-submit">ìˆ˜ì • ì™„ë£Œ</button>
    </div>
  </form>
</div>
{% endblock %}

{% block extra_scripts %}
<script src="https://cdn.quilljs.com/1.3.6/quill.js"></script>
<script>
  // Quill ì—ë””í„° ì´ˆê¸°í™”
  const quill = new Quill('#editor', {
    theme: 'snow',
    modules: {
      toolbar: {
        container: [
          [{ 'header': [1, 2, 3, false] }],
          ['bold', 'italic', 'underline', 'strike'],
          [{ 'list': 'ordered'}, { 'list': 'bullet' }],
          [{ 'color': [] }, { 'background': [] }],
          ['link', 'image'],
          ['clean']
        ],
        handlers: {
          'image': imageHandler
        }
      }
    },
    placeholder: 'ê²Œì‹œê¸€ ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”...'
  });

  // ê¸°ì¡´ contentë¥¼ ì—ë””í„°ì— ë¡œë“œ
  const existingContent = {{ post.content | tojson | safe }};
  if (existingContent) {
    quill.root.innerHTML = existingContent;
  }

  // ì´ë¯¸ì§€ ì—…ë¡œë“œ í•¸ë“¤ëŸ¬
  async function imageHandler() {
    const input = document.createElement('input');
    input.setAttribute('type', 'file');
    input.setAttribute('accept', 'image/*');
    input.click();

    input.onchange = async () => {
      const file = input.files[0];
      if (!file) return;

      // íŒŒì¼ í¬ê¸° ì²´í¬ (5MB ì œí•œ)
      if (file.size > 5 * 1024 * 1024) {
        alert('ì´ë¯¸ì§€ í¬ê¸°ëŠ” 5MB ì´í•˜ì—¬ì•¼ í•©ë‹ˆë‹¤.');
        return;
      }

      const formData = new FormData();
      formData.append('file', file);

      try {
        // ë¡œë”© í‘œì‹œ
        const range = quill.getSelection();
        const index = range ? range.index : quill.getLength();
        quill.insertText(index, 'ì´ë¯¸ì§€ ì—…ë¡œë“œ ì¤‘...', 'user');
        quill.setSelection(index + 12, 0);

        // ì„œë²„ì— ì´ë¯¸ì§€ ì—…ë¡œë“œ
        const response = await fetch('/api/upload-image', {
          method: 'POST',
          body: formData
        });

        if (!response.ok) {
          throw new Error('ì´ë¯¸ì§€ ì—…ë¡œë“œ ì‹¤íŒ¨');
        }

        const data = await response.json();
        const imageUrl = data.url;

        // ì—…ë¡œë“œ ì¤‘ í…ìŠ¤íŠ¸ ì œê±°
        quill.deleteText(index, 12);
        
        // ì´ë¯¸ì§€ ì‚½ì…
        quill.insertEmbed(index, 'image', imageUrl);
      } catch (error) {
        alert('ì´ë¯¸ì§€ ì—…ë¡œë“œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error.message);
        // ì—…ë¡œë“œ ì¤‘ í…ìŠ¤íŠ¸ ì œê±°
        const range = quill.getSelection();
        if (range) {
          quill.deleteText(range.index - 12, 12);
        }
      }
    };
  }

  // ì—ë””í„° ë‚´ìš©ì„ textareaì— ë™ê¸°í™”
  const form = document.getElementById('postForm');
  const contentInput = document.getElementById('content');
  
  form.addEventListener('submit', function(e) {
    // ì—ë””í„° ë‚´ìš© ê°€ì ¸ì˜¤ê¸°
    const editorContent = quill.root.innerHTML;
    
    // ì—ë””í„°ê°€ ë¹„ì–´ìˆëŠ”ì§€ í™•ì¸ (í…ìŠ¤íŠ¸ë§Œ ì¶”ì¶œ)
    const textContent = quill.getText().trim();
    if (!textContent) {
      e.preventDefault();
      alert('ë‚´ìš©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
      return false;
    }
    
    // HTML ë‚´ìš©ì„ textareaì— ì €ì¥
    contentInput.value = editorContent;
    
    // ì œëª© í™•ì¸
    const titleInput = document.getElementById('title');
    if (!titleInput.value.trim()) {
      e.preventDefault();
      alert('ì œëª©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
      return false;
    }
  });

  // íŒŒì¼ ì—…ë¡œë“œ ê¸°ëŠ¥
  const fileUploadArea = document.getElementById('fileUploadArea');
  const fileInput = document.getElementById('fileInput');
  const fileList = document.getElementById('fileList');
  let selectedFiles = [];

  // íŒŒì¼ ì—…ë¡œë“œ ì˜ì—­ í´ë¦­
  fileUploadArea.addEventListener('click', () => {
    fileInput.click();
  });

  // ë“œë˜ê·¸ ì•¤ ë“œë¡­
  fileUploadArea.addEventListener('dragover', (e) => {
    e.preventDefault();
    fileUploadArea.classList.add('dragover');
  });

  fileUploadArea.addEventListener('dragleave', () => {
    fileUploadArea.classList.remove('dragover');
  });

  fileUploadArea.addEventListener('drop', (e) => {
    e.preventDefault();
    fileUploadArea.classList.remove('dragover');
    const files = Array.from(e.dataTransfer.files);
    addFiles(files);
  });

  // íŒŒì¼ ì„ íƒ
  fileInput.addEventListener('change', (e) => {
    const files = Array.from(e.target.files);
    addFiles(files);
  });

  // íŒŒì¼ ì¶”ê°€
  function addFiles(files) {
    files.forEach(file => {
      selectedFiles.push(file);
      displayFile(file);
    });
    updateFileInput();
  }

  // íŒŒì¼ í‘œì‹œ
  function displayFile(file) {
    const fileItem = document.createElement('div');
    fileItem.className = 'file-item';
    fileItem.dataset.filename = file.name;
    
    fileItem.innerHTML = `
      <span class="file-item-name">ğŸ“ ${file.name}</span>
      <button type="button" class="file-item-remove" onclick="removeFile('${file.name}')">ì œê±°</button>
    `;
    
    fileList.appendChild(fileItem);
    fileList.style.display = 'block';
  }

  // íŒŒì¼ ì œê±°
  window.removeFile = function(filename) {
    selectedFiles = selectedFiles.filter(f => f.name !== filename);
    const fileItem = fileList.querySelector(`[data-filename="${filename}"]`);
    if (fileItem) {
      fileItem.remove();
    }
    if (selectedFiles.length === 0) {
      fileList.style.display = 'none';
    }
    updateFileInput();
  };

  // íŒŒì¼ input ì—…ë°ì´íŠ¸
  function updateFileInput() {
    const dt = new DataTransfer();
    selectedFiles.forEach(file => {
      dt.items.add(file);
    });
    fileInput.files = dt.files;
  }
</script>
{% endblock %}

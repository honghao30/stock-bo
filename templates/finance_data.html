{% extends "base.html" %}

{% block title %}ê¸ˆìœµ ë°ì´í„° í™•ì¸ - BO System{% endblock %}

{% block extra_styles %}
<style>
  /* ìµœìƒìœ„ ì¹´í…Œê³ ë¦¬ íƒ­ ìŠ¤íƒ€ì¼ - í° ì¹´ë“œ í˜•íƒœ */
  .category-tabs {
    display: flex;
    gap: 20px;
    margin-bottom: 30px;
    padding: 10px 0;
  }

  .category-tab {
    flex: 1;
    padding: 20px 30px;
    background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
    border: 2px solid #dee2e6;
    border-radius: 12px;
    cursor: pointer;
    font-size: 18px;
    font-weight: 700;
    color: #495057;
    transition: all 0.3s;
    text-align: center;
    position: relative;
    box-shadow: 0 2px 8px rgba(0,0,0,0.08);
  }

  .category-tab:hover {
    background: linear-gradient(135deg, #e9ecef 0%, #dee2e6 100%);
    border-color: #adb5bd;
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(0,0,0,0.12);
  }

  .category-tab.active {
    background: linear-gradient(135deg, #3498db 0%, #2980b9 100%);
    border-color: #2980b9;
    color: white;
    box-shadow: 0 4px 16px rgba(52, 152, 219, 0.3);
    transform: translateY(-2px);
  }

  .category-tab.active::before {
    content: 'âœ“';
    position: absolute;
    top: 8px;
    right: 12px;
    font-size: 14px;
    background: rgba(255, 255, 255, 0.3);
    width: 24px;
    height: 24px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: bold;
  }

  /* ì¹´í…Œê³ ë¦¬ ì½˜í…ì¸  */
  .category-content {
    display: none;
  }

  .category-content.active {
    display: block;
    animation: fadeIn 0.3s;
  }

  .tab-container {
    margin-top: 20px;
  }

  /* 2ë‹¨ê³„ í•˜ìœ„ íƒ­ ìŠ¤íƒ€ì¼ - ì‘ì€ íƒ­ í˜•íƒœ */
  .tab-buttons {
    display: flex;
    border-bottom: 1px solid #e0e0e0;
    margin-bottom: 20px;
    flex-wrap: wrap;
    background: white;
    padding: 5px 5px 0 5px;
    border-radius: 6px 6px 0 0;
  }

  .tab-button {
    padding: 10px 18px;
    background: transparent;
    border: none;
    border-bottom: 2px solid transparent;
    cursor: pointer;
    font-size: 13px;
    font-weight: 500;
    color: #6c757d;
    transition: all 0.2s;
    margin-right: 3px;
    border-radius: 4px 4px 0 0;
    position: relative;
  }

  .tab-button:hover {
    background: #f1f3f5;
    color: #495057;
  }

  .tab-button.active {
    background: #f8f9fa;
    color: #2c3e50;
    border-bottom-color: #2c3e50;
    font-weight: 600;
  }

  .tab-button.active::after {
    content: '';
    position: absolute;
    bottom: -1px;
    left: 0;
    right: 0;
    height: 2px;
    background: #2c3e50;
  }

  .tab-content {
    display: none;
    animation: fadeIn 0.3s;
  }

  .tab-content.active {
    display: block;
  }

  @keyframes fadeIn {
    from { opacity: 0; transform: translateY(10px); }
    to { opacity: 1; transform: translateY(0); }
  }

  .tab-section {
    margin-bottom: 30px;
  }

  .tab-section-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-bottom: 15px;
    flex-wrap: wrap;
  }

  .tab-section-header h3 {
    color: #2c3e50;
    margin: 0;
    flex: 1;
  }

  .btn-fetch {
    padding: 10px 20px;
    background: #3498db;
    color: white;
    border: none;
    border-radius: 4px;
    cursor: pointer;
    font-size: 14px;
    transition: background 0.3s;
  }

  .btn-fetch:hover {
    background: #2980b9;
  }

  .btn-fetch:disabled {
    background: #95a5a6;
    cursor: not-allowed;
  }

  .info-badge {
    display: inline-block;
    padding: 4px 12px;
    border-radius: 4px;
    font-size: 12px;
    font-weight: 500;
    margin-left: 10px;
  }

  .info-badge.waiting {
    background: #e8f4fd;
    color: #2980b9;
  }

  .info-badge.loading {
    background: #fff3cd;
    color: #856404;
  }

  .info-badge.success {
    background: #d4edda;
    color: #155724;
  }

  .info-badge.error {
    background: #f8d7da;
    color: #721c24;
  }

  .data-table-container {
    margin-top: 20px;
    background: white;
    border: 1px solid #dee2e6;
    border-radius: 4px;
    overflow: hidden;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
  }

  .data-table {
    width: 100%;
    border-collapse: collapse;
    font-size: 13px;
  }

  .data-table thead {
    background: #3498db;
    color: white;
  }

  .data-table th {
    padding: 12px;
    text-align: left;
    font-weight: 600;
    border-bottom: 2px solid #2980b9;
  }

  .data-table td {
    padding: 10px 12px;
    border-bottom: 1px solid #dee2e6;
  }

  .data-table tbody tr:hover {
    background: #f8f9fa;
  }

  .data-table tbody tr:last-child td {
    border-bottom: none;
  }

  .loading {
    padding: 40px;
    text-align: center;
    color: #3498db;
    font-style: italic;
  }

  .error {
    padding: 15px;
    color: #721c24;
    background: #f8d7da;
    border-radius: 4px;
    margin-top: 15px;
  }

  .success-message {
    padding: 12px;
    color: #155724;
    background: #d4edda;
    border-radius: 4px;
    margin-bottom: 15px;
    font-weight: 500;
  }

  .empty-message {
    padding: 40px;
    text-align: center;
    color: #6c757d;
    font-style: italic;
  }

  .coming-soon {
    padding: 60px 20px;
    text-align: center;
    color: #6c757d;
  }

  .coming-soon-icon {
    font-size: 48px;
    margin-bottom: 15px;
  }

  .coming-soon h3 {
    color: #2c3e50;
    margin-bottom: 10px;
  }

  /* ë°˜ì‘í˜• */
  .data-table-container {
    overflow-x: auto;
  }

  @media (max-width: 768px) {
    .category-tabs {
      flex-direction: column;
      gap: 10px;
    }

    .category-tab {
      padding: 16px 20px;
      font-size: 16px;
    }

    .tab-button {
      padding: 8px 14px;
      font-size: 12px;
    }

    .data-table {
      font-size: 12px;
    }

    .data-table th,
    .data-table td {
      padding: 8px;
    }
  }
</style>
{% endblock %}

{% block content %}
<div class="card">
  <h2 style="color: #2c3e50; margin-top: 0">ğŸ“Š ê¸ˆìœµ ë°ì´í„° í™•ì¸</h2>
  <p style="color: #666">
    ê¸ˆìœµìœ„ì›íšŒ ë° í•œêµ­ê±°ë˜ì†Œì—ì„œ ì œê³µí•˜ëŠ” ë°ì´í„°ë¥¼ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
  </p>

  <!-- ìµœìƒìœ„ ì¹´í…Œê³ ë¦¬ íƒ­ -->
  <div class="category-tabs">
    <button class="category-tab active" onclick="switchCategory('krx')">
      ğŸ“ˆ í•œêµ­ê±°ë˜ì†Œ
    </button>
    <button class="category-tab" onclick="switchCategory('fsc')">
      ğŸ›ï¸ ê¸ˆìœµìœ„ì›íšŒ
    </button>
  </div>

  <!-- í•œêµ­ê±°ë˜ì†Œ ì¹´í…Œê³ ë¦¬ ì½˜í…ì¸  -->
  <div id="category-krx" class="category-content active">
    <div class="tab-container">
      <!-- í•˜ìœ„ íƒ­ ë²„íŠ¼ -->
      <div class="tab-buttons">
        <button class="tab-button active" onclick="switchTab('krx', 'daily')">
          ğŸ“ˆ ì‹œì¥ í˜„í™©
        </button>
        <button class="tab-button" onclick="switchTab('krx', 'kospi')">
          ğŸ’¹ ì½”ìŠ¤í”¼
        </button>
        <button class="tab-button" onclick="switchTab('krx', 'kosdaq')">
          ğŸš€ ì½”ìŠ¤ë‹¥
        </button>
      </div>

      <!-- ì‹œì¥ í˜„í™© íƒ­ -->
      <div id="tab-krx-daily" class="tab-content active">
        <div class="tab-section">
          <div class="tab-section-header">
            <h3>ì „ì²´ ì‹œì¥ í˜„í™©</h3>
          </div>
          <div id="market-data" class="data-table-container" style="display: block;"></div>
        </div>
      </div>

      <!-- ì½”ìŠ¤í”¼ íƒ­ -->
      <div id="tab-krx-kospi" class="tab-content">
        <div class="tab-section">
          <div class="tab-section-header">
            <h3>ì½”ìŠ¤í”¼ ì§€ìˆ˜ ì •ë³´</h3>
          </div>
          <div id="kospi-data" class="data-table-container" style="display: block;"></div>
        </div>
      </div>

      <!-- ì½”ìŠ¤ë‹¥ íƒ­ -->
      <div id="tab-krx-kosdaq" class="tab-content">
        <div class="tab-section">
          <div class="tab-section-header">
            <h3>ì½”ìŠ¤ë‹¥ ì§€ìˆ˜ ì •ë³´</h3>
          </div>
          <div id="kosdaq-data" class="data-table-container" style="display: block;"></div>
        </div>
      </div>
    </div>
  </div>

  <!-- ê¸ˆìœµìœ„ì›íšŒ ì¹´í…Œê³ ë¦¬ ì½˜í…ì¸  -->
  <div id="category-fsc" class="category-content">
    <div class="tab-container">
      <!-- í•˜ìœ„ íƒ­ ë²„íŠ¼ -->
      <div class="tab-buttons">
        <button class="tab-button active" onclick="switchTab('fsc', 'bonus')">
          ğŸ ë¬´ìƒì¦ì
        </button>
        <button class="tab-button" onclick="switchTab('fsc', 'dividend')">
          ğŸ’° ë°°ë‹¹ê³µì‹œì •ë³´
        </button>
        <button class="tab-button" onclick="switchTab('fsc', 'price')">
          ğŸ’¹ ì£¼ì‹ì‹œì„¸ì •ë³´
        </button>
      </div>

      <!-- ë¬´ìƒì¦ì íƒ­ -->
      <div id="tab-fsc-bonus" class="tab-content active">
        <div class="tab-section">
          <div class="tab-section-header">
            <h3>ë¬´ìƒì¦ì ê³µì‹œì •ë³´ (getBonuIssuDiscInfo_V2)</h3>
          </div>
          <div id="bonus-data" class="data-table-container" style="display: block;"></div>
        </div>
      </div>

      <!-- ë°°ë‹¹ê³µì‹œì •ë³´ íƒ­ -->
      <div id="tab-fsc-dividend" class="tab-content">
        <div class="tab-section">
          <div class="tab-section-header">
            <h3>ë°°ë‹¹ê³µì‹œì •ë³´ (getDiviDiscInfo_V2)</h3>
          </div>
          <div id="dividend-data" class="data-table-container" style="display: block;"></div>
        </div>
      </div>

      <!-- ì£¼ì‹ì‹œì„¸ì •ë³´ íƒ­ -->
      <div id="tab-fsc-price" class="tab-content">
        <div class="tab-section">
          <div class="tab-section-header">
            <h3>ì£¼ì‹ì‹œì„¸ì •ë³´ (getStockPriceInfo)</h3>
          </div>
          <div id="price-data" class="data-table-container" style="display: block;"></div>
        </div>
      </div>

    </div>
  </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
  // ì¹´í…Œê³ ë¦¬ ì „í™˜ í•¨ìˆ˜
  function switchCategory(category) {
    // ëª¨ë“  ì¹´í…Œê³ ë¦¬ íƒ­ê³¼ ì½˜í…ì¸  ë¹„í™œì„±í™”
    document.querySelectorAll('.category-tab').forEach(btn => btn.classList.remove('active'));
    document.querySelectorAll('.category-content').forEach(content => content.classList.remove('active'));

    // ì„ íƒëœ ì¹´í…Œê³ ë¦¬ í™œì„±í™”
    document.querySelector(`button[onclick="switchCategory('${category}')"]`).classList.add('active');
    document.getElementById(`category-${category}`).classList.add('active');

    // í•´ë‹¹ ì¹´í…Œê³ ë¦¬ì˜ ì²« ë²ˆì§¸ íƒ­ í™œì„±í™”
    const firstTab = category === 'krx' ? 'daily' : 'bonus';
    switchTab(category, firstTab);
  }

  // íƒ­ ì „í™˜ í•¨ìˆ˜ (ì¹´í…Œê³ ë¦¬ í¬í•¨)
  function switchTab(category, tabName) {
    // í˜„ì¬ ì¹´í…Œê³ ë¦¬ì˜ ëª¨ë“  íƒ­ ë²„íŠ¼ê³¼ ì½˜í…ì¸  ë¹„í™œì„±í™”
    const categoryEl = document.getElementById(`category-${category}`);
    categoryEl.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('active'));
    categoryEl.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));

    // ì„ íƒëœ íƒ­ í™œì„±í™”
    const tabButton = categoryEl.querySelector(`button[onclick="switchTab('${category}', '${tabName}')"]`);
    if (tabButton) {
      tabButton.classList.add('active');
    }
    const tabContent = document.getElementById(`tab-${category}-${tabName}`);
    if (tabContent) {
      tabContent.classList.add('active');
    }

    // ê¸ˆìœµìœ„ì›íšŒ ì¹´í…Œê³ ë¦¬ì¸ ê²½ìš° ìë™ìœ¼ë¡œ ë°ì´í„° ë¡œë“œ
    if (category === 'fsc') {
      switch(tabName) {
        case 'bonus':
          fetchBonusIssuanceInfo();
          break;
        case 'dividend':
          fetchDividendInfo();
          break;
        case 'price':
          fetchStockPrice();
          break;
      }
    }
    
    // í•œêµ­ê±°ë˜ì†Œ ì¹´í…Œê³ ë¦¬ì¸ ê²½ìš° ìë™ìœ¼ë¡œ ë°ì´í„° ë¡œë“œ
    if (category === 'krx') {
      switch(tabName) {
        case 'daily':
          fetchMarketOverview();
          break;
        case 'kospi':
          fetchKospiIndex();
          break;
        case 'kosdaq':
          fetchKosdaqIndex();
          break;
      }
    }
  }

  // JSON ë°ì´í„°ë¥¼ í…Œì´ë¸”ë¡œ ë³€í™˜
  function jsonToTable(data) {
    try {
      // API ì‘ë‹µ êµ¬ì¡°ì— ë”°ë¼ items ì¶”ì¶œ
      let items = [];
      
      if (data.response && data.response.body && data.response.body.items) {
        const itemsObj = data.response.body.items;
        if (itemsObj.item) {
          items = Array.isArray(itemsObj.item) ? itemsObj.item : [itemsObj.item];
        }
      } else if (Array.isArray(data)) {
        items = data;
      } else if (data.items) {
        items = Array.isArray(data.items) ? data.items : [data.items];
      }

      if (!items || items.length === 0) {
        return '<div class="empty-message">ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</div>';
      }

      // ì²« ë²ˆì§¸ ì•„ì´í…œì—ì„œ ëª¨ë“  í‚¤ ì¶”ì¶œ
      const allKeys = new Set();
      items.forEach(item => {
        if (typeof item === 'object' && item !== null) {
          Object.keys(item).forEach(key => allKeys.add(key));
        }
      });

      const columns = Array.from(allKeys);

      // í…Œì´ë¸” ìƒì„±
      let html = '<table class="data-table"><thead><tr>';
      
      // í—¤ë”
      columns.forEach(key => {
        html += `<th>${formatColumnName(key)}</th>`;
      });
      html += '</tr></thead><tbody>';

      // ë°ì´í„° í–‰
      items.forEach(item => {
        html += '<tr>';
        columns.forEach(key => {
          const value = item[key] !== null && item[key] !== undefined ? item[key] : '-';
          html += `<td>${escapeHtml(String(value))}</td>`;
        });
        html += '</tr>';
      });

      html += '</tbody></table>';
      return html;

    } catch (error) {
      return `<div class="error">ë°ì´í„° íŒŒì‹± ì˜¤ë¥˜: ${error.message}</div>`;
    }
  }

  // ì»¬ëŸ¼ëª… í¬ë§·íŒ… (í•œê¸€ ë³€í™˜)
  // 1. ì»¬ëŸ¼ëª… í¬ë§·íŒ… í•¨ìˆ˜ì— KRX ëŒ€ë¬¸ì í•„ë“œ ì¶”ê°€
  function formatColumnName(key) {
  const columnMap = {
    'BAS_DD': 'ê¸°ì¤€ì¼ì',
    'IDX_NM': 'ì§€ìˆ˜ëª…',
    'CLSPRC_IDX': 'ì¢…ê°€',
    'CMPPREVDD_IDX': 'ëŒ€ë¹„',
    'FLUC_RT': 'ë“±ë½ë¥ (%)',
    'OPNPRC_IDX': 'ì‹œê°€',
    'HGPRC_IDX': 'ê³ ê°€',
    'LWPRC_IDX': 'ì €ê°€',
    'ACC_TRDVOL': 'ê±°ë˜ëŸ‰',
    'ACC_TRDVAL': 'ê±°ë˜ëŒ€ê¸ˆ',
    'MKTCAP': 'ìƒì¥ì‹œê°€ì´ì•¡'
  };
  return columnMap[key] || key;
}

  // HTML ì´ìŠ¤ì¼€ì´í”„
  function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
  }

  // ë°°ë‹¹ê³µì‹œì •ë³´ ì¡°íšŒ
  async function fetchDividendInfo() {
    const dataEl = document.getElementById('dividend-data');
    dataEl.innerHTML = '<div class="loading">ë°ì´í„°ë¥¼ ê°€ì ¸ì˜¤ëŠ” ì¤‘...</div>';

    try {
      const response = await fetch('/api/disclosure-info?page_no=1&num_of_rows=10');
      const data = await response.json();
      
      if (response.ok) {
        dataEl.innerHTML = jsonToTable(data);
      } else {
        throw new Error(data.error || data.detail || 'ë°ì´í„°ë¥¼ ê°€ì ¸ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
      }
    } catch (error) {
      dataEl.innerHTML = `<div class="error">ì˜¤ë¥˜ ë°œìƒ: ${error.message}</div>`;
    }
  }

  // ë¬´ìƒì¦ì ê³µì‹œì •ë³´ ì¡°íšŒ
  async function fetchBonusIssuanceInfo() {
    const dataEl = document.getElementById('bonus-data');
    dataEl.innerHTML = '<div class="loading">ë°ì´í„°ë¥¼ ê°€ì ¸ì˜¤ëŠ” ì¤‘...</div>';

    try {
      const response = await fetch('/api/bonus-issuance-info?page_no=1&num_of_rows=10');
      const data = await response.json();
      
      if (response.ok) {
        dataEl.innerHTML = jsonToTable(data);
      } else {
        throw new Error(data.error || data.detail || 'ë°ì´í„°ë¥¼ ê°€ì ¸ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
      }
    } catch (error) {
      dataEl.innerHTML = `<div class="error">ì˜¤ë¥˜ ë°œìƒ: ${error.message}</div>`;
    }
  }

  // ì£¼ì‹ì‹œì„¸ì •ë³´ ì¡°íšŒ
  async function fetchStockPrice() {
    const dataEl = document.getElementById('price-data');
    dataEl.innerHTML = '<div class="loading">ë°ì´í„°ë¥¼ ê°€ì ¸ì˜¤ëŠ” ì¤‘...</div>';

    try {
      const response = await fetch('/api/stock-price?page_no=1&num_of_rows=10');
      const data = await response.json();
      
      if (response.ok) {
        dataEl.innerHTML = jsonToTable(data);
      } else {
        throw new Error(data.error || data.detail || 'ë°ì´í„°ë¥¼ ê°€ì ¸ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
      }
    } catch (error) {
      dataEl.innerHTML = `<div class="error">ì˜¤ë¥˜ ë°œìƒ: ${error.message}</div>`;
    }
  }

  // ì „ì²´ ì‹œì¥ í˜„í™© ì¡°íšŒ
  async function fetchMarketOverview() {
  const dataEl = document.getElementById('market-data');
  if (!dataEl) return;
  dataEl.innerHTML = '<div class="loading">ë°ì´í„°ë¥¼ ê°€ì ¸ì˜¤ëŠ” ì¤‘...</div>';

  try {
    const response = await fetch('/api/krx-market');
    const data = await response.json();
    
    if (response.ok) {
      // ë°±ì—”ë“œì—ì„œ {kospi: [], kosdaq: []} í˜•íƒœë¡œ ì˜¤ë¯€ë¡œ ì²˜ë¦¬
      let html = '<div style="display: flex; flex-direction: column; gap: 30px;">';
      
      if (data.kospi && data.kospi.length > 0) {
        html += '<div><h4>ğŸ“ˆ ì½”ìŠ¤í”¼ ì§€ìˆ˜</h4>' + createIndexTable(data.kospi) + '</div>';
      }
      if (data.kosdaq && data.kosdaq.length > 0) {
        html += '<div><h4>ğŸ’¼ ì½”ìŠ¤ë‹¥ ì§€ìˆ˜</h4>' + createIndexTable(data.kosdaq) + '</div>';
      }
      
      if (html === '<div style="display: flex; flex-direction: column; gap: 30px;">') {
        dataEl.innerHTML = '<div class="empty-message">ì¡°íšŒëœ ì‹œì¥ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</div>';
      } else {
        dataEl.innerHTML = html + '</div>';
      }
    }
  } catch (error) {
    dataEl.innerHTML = `<div class="error">ì˜¤ë¥˜: ${error.message}</div>`;
  }
}

  // ì½”ìŠ¤í”¼ ì§€ìˆ˜ ì¡°íšŒ
  async function fetchKospiIndex() {
    const dataEl = document.getElementById('kospi-data');
    dataEl.innerHTML = '<div class="loading">ë°ì´í„°ë¥¼ ê°€ì ¸ì˜¤ëŠ” ì¤‘...</div>';

    try {
      const response = await fetch('/api/krx-kospi');
      const data = await response.json();
      
      console.log('ì½”ìŠ¤í”¼ API ì‘ë‹µ:', data);
      
      if (response.ok) {
        if (data.error) {
          throw new Error(data.error);
        }
        
        // ë°±ì—”ë“œì—ì„œ ë¦¬ìŠ¤íŠ¸ë¥¼ ì§ì ‘ ë°˜í™˜í•˜ë¯€ë¡œ, ë¦¬ìŠ¤íŠ¸ì¸ì§€ í™•ì¸
        let items = Array.isArray(data) ? data : [];
        console.log('ì›ë³¸ items:', items);
        console.log('ì›ë³¸ items ê¸¸ì´:', items.length);
        
        if (items.length > 0) {
          console.log('ì²« ë²ˆì§¸ í•­ëª©:', items[0]);
          console.log('ì²« ë²ˆì§¸ í•­ëª©ì˜ IDX_CLSS:', items[0]?.IDX_CLSS);
        }
        
        // ì½”ìŠ¤í”¼ ì§€ìˆ˜ë§Œ í•„í„°ë§ (IDX_CLSSê°€ 'KOSPI'ì¸ ê²ƒë§Œ)
        const filteredItems = items.filter(item => {
          if (!item) return false;
          const idxClass = item.IDX_CLSS;
          console.log('í•„í„°ë§ ì²´í¬ - IDX_CLSS:', idxClass, 'ë§¤ì¹­:', idxClass === 'KOSPI');
          return idxClass === 'KOSPI';
        });
        console.log('í•„í„°ë§ í›„ ë°ì´í„°:', filteredItems);
        console.log('í•„í„°ë§ í›„ ë°ì´í„° ê¸¸ì´:', filteredItems.length, 'ê°œ í•­ëª©');
        
        if (filteredItems.length === 0 && items.length > 0) {
          console.warn('âš ï¸ í•„í„°ë§ ê²°ê³¼ê°€ ë¹„ì–´ìˆìŠµë‹ˆë‹¤. ì›ë³¸ ë°ì´í„°ì˜ IDX_CLSS ê°’ë“¤:', items.map(i => i?.IDX_CLSS));
        }
        
        const tableHtml = jsonToKospiTable(filteredItems);
        console.log('ìƒì„±ëœ í…Œì´ë¸” HTML:', tableHtml.substring(0, 200));
        console.log('ìƒì„±ëœ í…Œì´ë¸” HTML ê¸¸ì´:', tableHtml.length);
        
        dataEl.innerHTML = tableHtml;
      } else {
        throw new Error(data.error || data.detail || 'ë°ì´í„°ë¥¼ ê°€ì ¸ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
      }
    } catch (error) {
      console.error('ì½”ìŠ¤í”¼ ì§€ìˆ˜ ì¡°íšŒ ì˜¤ë¥˜:', error);
      dataEl.innerHTML = `<div class="error">ì˜¤ë¥˜ ë°œìƒ: ${error.message}</div>`;
    }
  }

  // ì½”ìŠ¤ë‹¥ ì§€ìˆ˜ ì¡°íšŒ
  async function fetchKosdaqIndex() {
    const dataEl = document.getElementById('kosdaq-data');
    dataEl.innerHTML = '<div class="loading">ë°ì´í„°ë¥¼ ê°€ì ¸ì˜¤ëŠ” ì¤‘...</div>';

    try {
      const response = await fetch('/api/krx-kosdaq');
      const data = await response.json();
      
      if (response.ok) {
        if (data.error) {
          throw new Error(data.error);
        }
        
        // ë°±ì—”ë“œì—ì„œ ë¦¬ìŠ¤íŠ¸ë¥¼ ì§ì ‘ ë°˜í™˜í•˜ë¯€ë¡œ, ë¦¬ìŠ¤íŠ¸ì¸ì§€ í™•ì¸
        let items = Array.isArray(data) ? data : [];
        
        // ì½”ìŠ¤ë‹¥ ì§€ìˆ˜ë§Œ í•„í„°ë§ (IDX_CLSSê°€ 'KOSDAQ'ì¸ ê²ƒë§Œ)
        const filteredItems = items.filter(item => item && item.IDX_CLSS === 'KOSDAQ');
        
        dataEl.innerHTML = jsonToKospiTable(filteredItems);
      } else {
        throw new Error(data.error || data.detail || 'ë°ì´í„°ë¥¼ ê°€ì ¸ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
      }
    } catch (error) {
      dataEl.innerHTML = `<div class="error">ì˜¤ë¥˜ ë°œìƒ: ${error.message}</div>`;
    }
  }

  // IDX_CLSSë¡œ í•„í„°ë§í•˜ëŠ” í—¬í¼ í•¨ìˆ˜
  function filterByIndexClass(data, indexClass) {
    try {
      let items = [];
      
      // ë°ì´í„° êµ¬ì¡°ì— ë”°ë¼ items ì¶”ì¶œ
      if (data.OutBlock_1) {
        items = Array.isArray(data.OutBlock_1) ? data.OutBlock_1 : [data.OutBlock_1];
      } else if (Array.isArray(data)) {
        items = data;
      } else if (data.items) {
        items = Array.isArray(data.items) ? data.items : [data.items];
      } else if (data.data) {
        items = Array.isArray(data.data) ? data.data : [data.data];
      }
      
      // IDX_CLSSë¡œ í•„í„°ë§
      const filteredItems = items.filter(item => item && item.IDX_CLSS === indexClass);
      
      // ì›ë˜ êµ¬ì¡° ìœ ì§€
      if (data.OutBlock_1) {
        return { ...data, OutBlock_1: filteredItems };
      } else if (Array.isArray(data)) {
        return filteredItems;
      } else {
        return { ...data, items: filteredItems };
      }
    } catch (error) {
      console.error('í•„í„°ë§ ì˜¤ë¥˜:', error);
      return data;
    }
  }

  // ì „ì²´ ì‹œì¥ í˜„í™© ë°ì´í„°ë¥¼ í…Œì´ë¸”ë¡œ ë³€í™˜
  function jsonToMarketTable(data) {
    try {
      console.log('jsonToMarketTable ì…ë ¥ ë°ì´í„°:', data);
      console.log('ë°ì´í„° íƒ€ì…:', typeof data);
      console.log('data.kospi:', data.kospi);
      console.log('data.kosdaq:', data.kosdaq);
      
      let kospiItems = [];
      let kosdaqItems = [];
      
      // ì½”ìŠ¤í”¼ ë°ì´í„° ì¶”ì¶œ ë° í•„í„°ë§ (ë°±ì—”ë“œì—ì„œ ë¦¬ìŠ¤íŠ¸ë¥¼ ì§ì ‘ ë°˜í™˜)
      if (data.kospi) {
        const kospiData = data.kospi;
        console.log('kospiData íƒ€ì…:', typeof kospiData, 'ë°°ì—´ ì—¬ë¶€:', Array.isArray(kospiData));
        if (Array.isArray(kospiData)) {
          console.log('kospiData ê¸¸ì´:', kospiData.length);
          kospiItems = kospiData.filter(item => {
            if (!item) return false;
            const idxClass = item.IDX_CLSS;
            console.log('KOSPI í•„í„°ë§ - IDX_CLSS:', idxClass, 'ë§¤ì¹­:', idxClass === 'KOSPI');
            return idxClass === 'KOSPI';
          });
          console.log('í•„í„°ë§ í›„ kospiItems:', kospiItems.length, 'ê°œ');
        }
      }
      
      // ì½”ìŠ¤ë‹¥ ë°ì´í„° ì¶”ì¶œ ë° í•„í„°ë§ (ë°±ì—”ë“œì—ì„œ ë¦¬ìŠ¤íŠ¸ë¥¼ ì§ì ‘ ë°˜í™˜)
      if (data.kosdaq) {
        const kosdaqData = data.kosdaq;
        console.log('kosdaqData íƒ€ì…:', typeof kosdaqData, 'ë°°ì—´ ì—¬ë¶€:', Array.isArray(kosdaqData));
        if (Array.isArray(kosdaqData)) {
          console.log('kosdaqData ê¸¸ì´:', kosdaqData.length);
          kosdaqItems = kosdaqData.filter(item => {
            if (!item) return false;
            const idxClass = item.IDX_CLSS;
            console.log('KOSDAQ í•„í„°ë§ - IDX_CLSS:', idxClass, 'ë§¤ì¹­:', idxClass === 'KOSDAQ');
            return idxClass === 'KOSDAQ';
          });
          console.log('í•„í„°ë§ í›„ kosdaqItems:', kosdaqItems.length, 'ê°œ');
        }
      }

      console.log('ìµœì¢… kospiItems:', kospiItems.length, 'kosdaqItems:', kosdaqItems.length);

      if (kospiItems.length === 0 && kosdaqItems.length === 0) {
        console.warn('âš ï¸ ëª¨ë“  ë°ì´í„°ê°€ ë¹„ì–´ìˆìŒ');
        return '<div class="empty-message">ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</div>';
      }

      let html = '<div style="display: flex; flex-direction: column; gap: 30px;">';
      
      // ì½”ìŠ¤í”¼ ì„¹ì…˜
      if (kospiItems.length > 0) {
        html += '<div><h4 style="color: #2c3e50; margin-bottom: 15px; font-size: 18px;">ğŸ“ˆ ì½”ìŠ¤í”¼ ì§€ìˆ˜</h4>';
        html += createIndexTable(kospiItems);
        html += '</div>';
      }
      
      // ì½”ìŠ¤ë‹¥ ì„¹ì…˜
      if (kosdaqItems.length > 0) {
        html += '<div><h4 style="color: #2c3e50; margin-bottom: 15px; font-size: 18px;">ğŸ’¼ ì½”ìŠ¤ë‹¥ ì§€ìˆ˜</h4>';
        html += createIndexTable(kosdaqItems);
        html += '</div>';
      }
      
      html += '</div>';
      return html;

    } catch (error) {
      console.error('jsonToMarketTable ì˜¤ë¥˜:', error);
      return `<div class="error">ë°ì´í„° íŒŒì‹± ì˜¤ë¥˜: ${error.message}</div>`;
    }
  }

  // ì§€ìˆ˜ í…Œì´ë¸” ìƒì„± í—¬í¼ í•¨ìˆ˜
  function createIndexTable(items) {
    console.log('createIndexTable í˜¸ì¶œ, items:', items);
    console.log('items íƒ€ì…:', typeof items, 'ë°°ì—´ ì—¬ë¶€:', Array.isArray(items));
    console.log('items ê¸¸ì´:', items ? items.length : 0);
    
    if (!items || !Array.isArray(items) || items.length === 0) {
      console.warn('createIndexTable: itemsê°€ ë¹„ì–´ìˆê±°ë‚˜ ë°°ì—´ì´ ì•„ë‹˜');
      return '<div class="empty-message">ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</div>';
    }
    
    const displayFields = [
      { key: 'BAS_DD', label: 'ê¸°ì¤€ì¼ì' },
      { key: 'IDX_NM', label: 'ì§€ìˆ˜ëª…' },
      { key: 'CLSPRC_IDX', label: 'ì¢…ê°€' },
      { key: 'CMPPREVDD_IDX', label: 'ëŒ€ë¹„' },
      { key: 'FLUC_RT', label: 'ë“±ë½ë¥ (%)' },
      { key: 'OPNPRC_IDX', label: 'ì‹œê°€' },
      { key: 'HGPRC_IDX', label: 'ê³ ê°€' },
      { key: 'LWPRC_IDX', label: 'ì €ê°€' },
      { key: 'ACC_TRDVOL', label: 'ê±°ë˜ëŸ‰' },
      { key: 'ACC_TRDVAL', label: 'ê±°ë˜ëŒ€ê¸ˆ' }
    ];

    let html = '<table class="data-table"><thead><tr>';
    displayFields.forEach(field => {
      html += `<th>${field.label}</th>`;
    });
    html += '</tr></thead><tbody>';

    const maxRows = 50;
    const displayItems = items.slice(0, maxRows);
    
    console.log('í‘œì‹œí•  í•­ëª© ìˆ˜:', displayItems.length);
    
    displayItems.forEach((item, index) => {
      console.log(`í•­ëª© ${index}:`, item);
      if (!item || typeof item !== 'object') {
        console.warn(`í•­ëª© ${index}ê°€ ìœ íš¨í•˜ì§€ ì•ŠìŒ:`, item);
        return;
      }
      
      html += '<tr>';
      displayFields.forEach(field => {
        let value = item[field.key];
        if (value === null || value === undefined || value === '') {
          value = '-';
        } else {
          if (['CLSPRC_IDX', 'CMPPREVDD_IDX', 'OPNPRC_IDX', 'HGPRC_IDX', 'LWPRC_IDX', 'ACC_TRDVOL', 'ACC_TRDVAL', 'MKTCAP'].includes(field.key)) {
            const numValue = parseFloat(value);
            if (!isNaN(numValue)) {
              value = numValue.toLocaleString('ko-KR');
            }
          }
          if (field.key === 'FLUC_RT') {
            const numValue = parseFloat(value);
            if (!isNaN(numValue)) {
              value = numValue.toFixed(2) + '%';
            }
          }
        }
        html += `<td>${escapeHtml(String(value))}</td>`;
      });
      html += '</tr>';
    });

    html += '</tbody></table>';
    
    if (items.length > maxRows) {
      html += `<div class="info-message" style="margin-top: 10px; color: #666;">
        ì´ ${items.length}ê°œì˜ ë°ì´í„° ì¤‘ ${maxRows}ê°œë§Œ í‘œì‹œë©ë‹ˆë‹¤.
      </div>`;
    }
    
    console.log('ìƒì„±ëœ HTML ê¸¸ì´:', html.length);
    return html;
  }

  // ì½”ìŠ¤í”¼ ì§€ìˆ˜ ë°ì´í„°ë¥¼ í…Œì´ë¸”ë¡œ ë³€í™˜
  function jsonToKospiTable(data) {
    try {
      console.log('jsonToKospiTable ì…ë ¥ ë°ì´í„°:', data);
      console.log('ë°ì´í„° íƒ€ì…:', typeof data, 'ë°°ì—´ ì—¬ë¶€:', Array.isArray(data));
      
      // dataê°€ ì´ë¯¸ ë¦¬ìŠ¤íŠ¸ì¸ ê²½ìš° ë°”ë¡œ ì‚¬ìš©
      let items = [];
      
      if (Array.isArray(data)) {
        items = data;
        console.log('ë¦¬ìŠ¤íŠ¸ë¡œ ë°›ìŒ:', items.length, 'ê°œ í•­ëª©');
      } else if (data && typeof data === 'object') {
        // ê°ì²´ì¸ ê²½ìš° ë‚´ë¶€ì—ì„œ ì°¾ê¸°
        if (data.OutBlock_1) {
          items = Array.isArray(data.OutBlock_1) ? data.OutBlock_1 : [data.OutBlock_1];
          console.log('OutBlock_1ì—ì„œ ì¶”ì¶œ:', items.length, 'ê°œ í•­ëª©');
        } else if (data.items) {
          items = Array.isArray(data.items) ? data.items : [data.items];
          console.log('itemsì—ì„œ ì¶”ì¶œ:', items.length, 'ê°œ í•­ëª©');
        } else if (data.data) {
          items = Array.isArray(data.data) ? data.data : [data.data];
          console.log('dataì—ì„œ ì¶”ì¶œ:', items.length, 'ê°œ í•­ëª©');
        } else {
          // ê°ì²´ ìì²´ê°€ í•˜ë‚˜ì˜ í•­ëª©ì¼ ìˆ˜ë„ ìˆìŒ
          items = [data];
          console.log('ê°ì²´ë¥¼ í•­ëª©ìœ¼ë¡œ ì‚¬ìš©');
        }
      } else {
        console.warn('ì•Œ ìˆ˜ ì—†ëŠ” ë°ì´í„° êµ¬ì¡°:', data);
        return '<div class="empty-message">ë°ì´í„° êµ¬ì¡°ë¥¼ ì¸ì‹í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</div>';
      }

      console.log('ìµœì¢… items:', items);
      console.log('items ê¸¸ì´:', items.length);
      console.log('ì²« ë²ˆì§¸ í•­ëª©:', items[0]);
      
      if (!items || items.length === 0) {
        console.warn('itemsê°€ ë¹„ì–´ìˆìŒ');
        return '<div class="empty-message">ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</div>';
      }

      // createIndexTable í•¨ìˆ˜ ì‚¬ìš©
      const result = createIndexTable(items);
      console.log('ìƒì„±ëœ HTML ê¸¸ì´:', result.length);
      return result;

    } catch (error) {
      console.error('jsonToKospiTable ì˜¤ë¥˜:', error);
      console.error('ìŠ¤íƒ:', error.stack);
      return `<div class="error">ë°ì´í„° íŒŒì‹± ì˜¤ë¥˜: ${error.message}</div>`;
    }
  }

  // í˜ì´ì§€ ë¡œë“œ ì‹œ ì´ˆê¸° ë°ì´í„° ìë™ ë¡œë“œ
  document.addEventListener('DOMContentLoaded', function() {
    // ê¸°ë³¸ í™œì„±í™”ëœ íƒ­ì— ë”°ë¼ ë°ì´í„° ë¡œë“œ
    const activeCategory = document.querySelector('.category-tab.active');
    if (activeCategory) {
      const onclickAttr = activeCategory.getAttribute('onclick');
      if (onclickAttr && onclickAttr.includes('krx')) {
        // í•œêµ­ê±°ë˜ì†Œê°€ ê¸°ë³¸ í™œì„±í™”ëœ ê²½ìš° - ì‹œì¥ í˜„í™© ë¡œë“œ
        fetchMarketOverview();
      } else {
        // ê¸ˆìœµìœ„ì›íšŒê°€ ê¸°ë³¸ í™œì„±í™”ëœ ê²½ìš°
        fetchBonusIssuanceInfo();
      }
    } else {
      // ê¸°ë³¸ê°’: ë¬´ìƒì¦ì ë°ì´í„° ë¡œë“œ
      fetchBonusIssuanceInfo();
    }
  });
</script>
{% endblock %}

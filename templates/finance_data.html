{% extends "base.html" %}

{% block title %}ê¸ˆìœµ ë°ì´í„° í™•ì¸ - BO System{% endblock %}

{% block extra_styles %}
<style>
  /* ìµœìƒìœ„ ì¹´í…Œê³ ë¦¬ íƒ­ ìŠ¤íƒ€ì¼ - í° ì¹´ë“œ í˜•íƒœ */
  .category-tabs {
    display: flex;
    gap: 20px;
    margin-bottom: 30px;
    padding: 10px 0;
  }

  .category-tab {
    flex: 1;
    padding: 20px 30px;
    background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
    border: 2px solid #dee2e6;
    border-radius: 12px;
    cursor: pointer;
    font-size: 18px;
    font-weight: 700;
    color: #495057;
    transition: all 0.3s;
    text-align: center;
    position: relative;
    box-shadow: 0 2px 8px rgba(0,0,0,0.08);
  }

  .category-tab:hover {
    background: linear-gradient(135deg, #e9ecef 0%, #dee2e6 100%);
    border-color: #adb5bd;
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(0,0,0,0.12);
  }

  .category-tab.active {
    background: linear-gradient(135deg, #3498db 0%, #2980b9 100%);
    border-color: #2980b9;
    color: white;
    box-shadow: 0 4px 16px rgba(52, 152, 219, 0.3);
    transform: translateY(-2px);
  }

  .category-tab.active::before {
    content: 'âœ“';
    position: absolute;
    top: 8px;
    right: 12px;
    font-size: 14px;
    background: rgba(255, 255, 255, 0.3);
    width: 24px;
    height: 24px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: bold;
  }

  /* ì¹´í…Œê³ ë¦¬ ì½˜í…ì¸  */
  .category-content {
    display: none;
  }

  .category-content.active {
    display: block;
    animation: fadeIn 0.3s;
  }

  .tab-container {
    margin-top: 20px;
  }

  /* 2ë‹¨ê³„ í•˜ìœ„ íƒ­ ìŠ¤íƒ€ì¼ - ì‘ì€ íƒ­ í˜•íƒœ */
  .tab-buttons {
    display: flex;
    border-bottom: 1px solid #e0e0e0;
    margin-bottom: 20px;
    flex-wrap: wrap;
    background: white;
    padding: 5px 5px 0 5px;
    border-radius: 6px 6px 0 0;
  }

  .tab-button {
    padding: 10px 18px;
    background: transparent;
    border: none;
    border-bottom: 2px solid transparent;
    cursor: pointer;
    font-size: 13px;
    font-weight: 500;
    color: #6c757d;
    transition: all 0.2s;
    margin-right: 3px;
    border-radius: 4px 4px 0 0;
    position: relative;
  }

  .tab-button:hover {
    background: #f1f3f5;
    color: #495057;
  }

  .tab-button.active {
    background: #f8f9fa;
    color: #2c3e50;
    border-bottom-color: #2c3e50;
    font-weight: 600;
  }

  .tab-button.active::after {
    content: '';
    position: absolute;
    bottom: -1px;
    left: 0;
    right: 0;
    height: 2px;
    background: #2c3e50;
  }

  .tab-content {
    display: none;
    animation: fadeIn 0.3s;
  }

  .tab-content.active {
    display: block;
  }

  @keyframes fadeIn {
    from { opacity: 0; transform: translateY(10px); }
    to { opacity: 1; transform: translateY(0); }
  }

  .tab-section {
    margin-bottom: 30px;
  }

  .tab-section-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-bottom: 15px;
    flex-wrap: wrap;
  }

  .tab-section-header h3 {
    color: #2c3e50;
    margin: 0;
    flex: 1;
  }

  .btn-fetch {
    padding: 10px 20px;
    background: #3498db;
    color: white;
    border: none;
    border-radius: 4px;
    cursor: pointer;
    font-size: 14px;
    transition: background 0.3s;
  }

  .btn-fetch:hover {
    background: #2980b9;
  }

  .btn-fetch:disabled {
    background: #95a5a6;
    cursor: not-allowed;
  }

  .info-badge {
    display: inline-block;
    padding: 4px 12px;
    border-radius: 4px;
    font-size: 12px;
    font-weight: 500;
    margin-left: 10px;
  }

  .info-badge.waiting {
    background: #e8f4fd;
    color: #2980b9;
  }

  .info-badge.loading {
    background: #fff3cd;
    color: #856404;
  }

  .info-badge.success {
    background: #d4edda;
    color: #155724;
  }

  .info-badge.error {
    background: #f8d7da;
    color: #721c24;
  }

  .data-table-container {
    margin-top: 20px;
    background: white;
    border: 1px solid #dee2e6;
    border-radius: 4px;
    overflow: hidden;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
  }

  .data-table {
    width: 100%;
    border-collapse: collapse;
    font-size: 13px;
  }

  .data-table thead {
    background: #3498db;
    color: white;
  }

  .data-table th {
    padding: 12px;
    text-align: left;
    font-weight: 600;
    border-bottom: 2px solid #2980b9;
  }

  .data-table td {
    padding: 10px 12px;
    border-bottom: 1px solid #dee2e6;
  }

  .data-table tbody tr:hover {
    background: #f8f9fa;
  }

  .data-table tbody tr:last-child td {
    border-bottom: none;
  }

  .loading {
    padding: 40px;
    text-align: center;
    color: #3498db;
    font-style: italic;
  }

  .error {
    padding: 15px;
    color: #721c24;
    background: #f8d7da;
    border-radius: 4px;
    margin-top: 15px;
  }

  .success-message {
    padding: 12px;
    color: #155724;
    background: #d4edda;
    border-radius: 4px;
    margin-bottom: 15px;
    font-weight: 500;
  }

  .empty-message {
    padding: 40px;
    text-align: center;
    color: #6c757d;
    font-style: italic;
  }

  .coming-soon {
    padding: 60px 20px;
    text-align: center;
    color: #6c757d;
  }

  .coming-soon-icon {
    font-size: 48px;
    margin-bottom: 15px;
  }

  .coming-soon h3 {
    color: #2c3e50;
    margin-bottom: 10px;
  }

  /* ë°˜ì‘í˜• */
  .data-table-container {
    overflow-x: auto;
  }

  @media (max-width: 768px) {
    .category-tabs {
      flex-direction: column;
      gap: 10px;
    }

    .category-tab {
      padding: 16px 20px;
      font-size: 16px;
    }

    .tab-button {
      padding: 8px 14px;
      font-size: 12px;
    }

    .data-table {
      font-size: 12px;
    }

    .data-table th,
    .data-table td {
      padding: 8px;
    }
  }
</style>
{% endblock %}

{% block content %}
<div class="card">
  <h2 style="color: #2c3e50; margin-top: 0">ğŸ“Š ê¸ˆìœµ ë°ì´í„° í™•ì¸</h2>
  <p style="color: #666">
    ê¸ˆìœµìœ„ì›íšŒ ë° í•œêµ­ê±°ë˜ì†Œì—ì„œ ì œê³µí•˜ëŠ” ë°ì´í„°ë¥¼ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
  </p>

  <!-- ìµœìƒìœ„ ì¹´í…Œê³ ë¦¬ íƒ­ -->
  <div class="category-tabs">
    <button class="category-tab active" onclick="switchCategory('fsc')">
      ğŸ›ï¸ ê¸ˆìœµìœ„ì›íšŒ
    </button>
    <button class="category-tab" onclick="switchCategory('krx')">
      ğŸ“ˆ í•œêµ­ê±°ë˜ì†Œ
    </button>
  </div>

  <!-- ê¸ˆìœµìœ„ì›íšŒ ì¹´í…Œê³ ë¦¬ ì½˜í…ì¸  -->
  <div id="category-fsc" class="category-content active">
    <div class="tab-container">
      <!-- í•˜ìœ„ íƒ­ ë²„íŠ¼ -->
      <div class="tab-buttons">
        <button class="tab-button active" onclick="switchTab('fsc', 'bonus')">
          ğŸ ë¬´ìƒì¦ì
        </button>
        <button class="tab-button" onclick="switchTab('fsc', 'dividend')">
          ğŸ’° ë°°ë‹¹ê³µì‹œì •ë³´
        </button>
        <button class="tab-button" onclick="switchTab('fsc', 'price')">
          ğŸ’¹ ì£¼ì‹ì‹œì„¸ì •ë³´
        </button>
      </div>

      <!-- ë¬´ìƒì¦ì íƒ­ -->
      <div id="tab-fsc-bonus" class="tab-content active">
        <div class="tab-section">
          <div class="tab-section-header">
            <h3>ë¬´ìƒì¦ì ê³µì‹œì •ë³´ (getBonuIssuDiscInfo_V2)</h3>
          </div>
          <div id="bonus-data" class="data-table-container" style="display: block;"></div>
        </div>
      </div>

      <!-- ë°°ë‹¹ê³µì‹œì •ë³´ íƒ­ -->
      <div id="tab-fsc-dividend" class="tab-content">
        <div class="tab-section">
          <div class="tab-section-header">
            <h3>ë°°ë‹¹ê³µì‹œì •ë³´ (getDiviDiscInfo_V2)</h3>
          </div>
          <div id="dividend-data" class="data-table-container" style="display: block;"></div>
        </div>
      </div>

      <!-- ì£¼ì‹ì‹œì„¸ì •ë³´ íƒ­ -->
      <div id="tab-fsc-price" class="tab-content">
        <div class="tab-section">
          <div class="tab-section-header">
            <h3>ì£¼ì‹ì‹œì„¸ì •ë³´ (getStockPriceInfo)</h3>
          </div>
          <div id="price-data" class="data-table-container" style="display: block;"></div>
        </div>
      </div>

    </div>
  </div>

  <!-- í•œêµ­ê±°ë˜ì†Œ ì¹´í…Œê³ ë¦¬ ì½˜í…ì¸  -->
  <div id="category-krx" class="category-content">
    <div class="tab-container">
      <!-- í•˜ìœ„ íƒ­ ë²„íŠ¼ -->
      <div class="tab-buttons">
        <button class="tab-button active" onclick="switchTab('krx', 'market')">
          ğŸ“Š ì‹œì¥ í˜„í™©
        </button>
        <button class="tab-button" onclick="switchTab('krx', 'daily')">
          ğŸ“… ì¼ì¼ ê±°ë˜ëŸ‰
        </button>
        <button class="tab-button" onclick="switchTab('krx', 'stock')">
          ğŸ’¼ ì¢…ëª© ì •ë³´
        </button>
      </div>

      <!-- ì‹œì¥ í˜„í™© íƒ­ -->
      <div id="tab-krx-market" class="tab-content active">
        <div class="tab-section">
          <div class="coming-soon">
            <div class="coming-soon-icon">ğŸš§</div>
            <h3>ì¤€ë¹„ ì¤‘ì…ë‹ˆë‹¤</h3>
            <p>í•œêµ­ê±°ë˜ì†Œ ì‹œì¥ í˜„í™© ë°ì´í„°ëŠ” ê³§ ì œê³µë  ì˜ˆì •ì…ë‹ˆë‹¤.</p>
          </div>
        </div>
      </div>

      <!-- ì¼ì¼ ê±°ë˜ëŸ‰ íƒ­ -->
      <div id="tab-krx-daily" class="tab-content">
        <div class="tab-section">
          <div class="coming-soon">
            <div class="coming-soon-icon">ğŸš§</div>
            <h3>ì¤€ë¹„ ì¤‘ì…ë‹ˆë‹¤</h3>
            <p>í•œêµ­ê±°ë˜ì†Œ ì¼ì¼ ê±°ë˜ëŸ‰ ë°ì´í„°ëŠ” ê³§ ì œê³µë  ì˜ˆì •ì…ë‹ˆë‹¤.</p>
          </div>
        </div>
      </div>

      <!-- ì¢…ëª© ì •ë³´ íƒ­ -->
      <div id="tab-krx-stock" class="tab-content">
        <div class="tab-section">
          <div class="coming-soon">
            <div class="coming-soon-icon">ğŸš§</div>
            <h3>ì¤€ë¹„ ì¤‘ì…ë‹ˆë‹¤</h3>
            <p>í•œêµ­ê±°ë˜ì†Œ ì¢…ëª© ì •ë³´ ë°ì´í„°ëŠ” ê³§ ì œê³µë  ì˜ˆì •ì…ë‹ˆë‹¤.</p>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
  // ì¹´í…Œê³ ë¦¬ ì „í™˜ í•¨ìˆ˜
  function switchCategory(category) {
    // ëª¨ë“  ì¹´í…Œê³ ë¦¬ íƒ­ê³¼ ì½˜í…ì¸  ë¹„í™œì„±í™”
    document.querySelectorAll('.category-tab').forEach(btn => btn.classList.remove('active'));
    document.querySelectorAll('.category-content').forEach(content => content.classList.remove('active'));

    // ì„ íƒëœ ì¹´í…Œê³ ë¦¬ í™œì„±í™”
    document.querySelector(`button[onclick="switchCategory('${category}')"]`).classList.add('active');
    document.getElementById(`category-${category}`).classList.add('active');

    // í•´ë‹¹ ì¹´í…Œê³ ë¦¬ì˜ ì²« ë²ˆì§¸ íƒ­ í™œì„±í™”
    const firstTab = category === 'fsc' ? 'bonus' : 'market';
    switchTab(category, firstTab);
  }

  // íƒ­ ì „í™˜ í•¨ìˆ˜ (ì¹´í…Œê³ ë¦¬ í¬í•¨)
  function switchTab(category, tabName) {
    // í˜„ì¬ ì¹´í…Œê³ ë¦¬ì˜ ëª¨ë“  íƒ­ ë²„íŠ¼ê³¼ ì½˜í…ì¸  ë¹„í™œì„±í™”
    const categoryEl = document.getElementById(`category-${category}`);
    categoryEl.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('active'));
    categoryEl.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));

    // ì„ íƒëœ íƒ­ í™œì„±í™”
    const tabButton = categoryEl.querySelector(`button[onclick="switchTab('${category}', '${tabName}')"]`);
    if (tabButton) {
      tabButton.classList.add('active');
    }
    const tabContent = document.getElementById(`tab-${category}-${tabName}`);
    if (tabContent) {
      tabContent.classList.add('active');
    }

    // ê¸ˆìœµìœ„ì›íšŒ ì¹´í…Œê³ ë¦¬ì¸ ê²½ìš° ìë™ìœ¼ë¡œ ë°ì´í„° ë¡œë“œ
    if (category === 'fsc') {
      switch(tabName) {
        case 'bonus':
          fetchBonusIssuanceInfo();
          break;
        case 'dividend':
          fetchDividendInfo();
          break;
        case 'price':
          fetchStockPrice();
          break;
      }
    }
  }

  // JSON ë°ì´í„°ë¥¼ í…Œì´ë¸”ë¡œ ë³€í™˜
  function jsonToTable(data) {
    try {
      // API ì‘ë‹µ êµ¬ì¡°ì— ë”°ë¼ items ì¶”ì¶œ
      let items = [];
      
      if (data.response && data.response.body && data.response.body.items) {
        const itemsObj = data.response.body.items;
        if (itemsObj.item) {
          items = Array.isArray(itemsObj.item) ? itemsObj.item : [itemsObj.item];
        }
      } else if (Array.isArray(data)) {
        items = data;
      } else if (data.items) {
        items = Array.isArray(data.items) ? data.items : [data.items];
      }

      if (!items || items.length === 0) {
        return '<div class="empty-message">ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</div>';
      }

      // ì²« ë²ˆì§¸ ì•„ì´í…œì—ì„œ ëª¨ë“  í‚¤ ì¶”ì¶œ
      const allKeys = new Set();
      items.forEach(item => {
        if (typeof item === 'object' && item !== null) {
          Object.keys(item).forEach(key => allKeys.add(key));
        }
      });

      const columns = Array.from(allKeys);

      // í…Œì´ë¸” ìƒì„±
      let html = '<table class="data-table"><thead><tr>';
      
      // í—¤ë”
      columns.forEach(key => {
        html += `<th>${formatColumnName(key)}</th>`;
      });
      html += '</tr></thead><tbody>';

      // ë°ì´í„° í–‰
      items.forEach(item => {
        html += '<tr>';
        columns.forEach(key => {
          const value = item[key] !== null && item[key] !== undefined ? item[key] : '-';
          html += `<td>${escapeHtml(String(value))}</td>`;
        });
        html += '</tr>';
      });

      html += '</tbody></table>';
      return html;

    } catch (error) {
      return `<div class="error">ë°ì´í„° íŒŒì‹± ì˜¤ë¥˜: ${error.message}</div>`;
    }
  }

  // ì»¬ëŸ¼ëª… í¬ë§·íŒ… (í•œê¸€ ë³€í™˜)
  function formatColumnName(key) {
    const columnMap = {
      'basDt': 'ê¸°ì¤€ì¼ì',
      'crno': 'ë²•ì¸ë“±ë¡ë²ˆí˜¸',
      'corpNm': 'ë²•ì¸ëª…',
      'diviAmt': 'ë°°ë‹¹ê¸ˆì•¡',
      'diviRcdb': 'ë°°ë‹¹ê¸°ì¤€ì¼',
      'diviPymntDt': 'ë°°ë‹¹ì§€ê¸‰ì¼',
      'stckIssuCmpyNm': 'ì£¼ì‹ë°œí–‰íšŒì‚¬ëª…',
      'stckParPrc': 'ì£¼ì‹ì•¡ë©´ê°€',
      'diviDcd': 'ë°°ë‹¹êµ¬ë¶„ì½”ë“œ',
      'diviDcdNm': 'ë°°ë‹¹êµ¬ë¶„ëª…',
      'isuExctDt': 'ë°œí–‰ì‹¤í–‰ì¼',
      'pymntStaDt': 'ì§€ê¸‰ì‹œì‘ì¼',
      'pymntEndDt': 'ì§€ê¸‰ì¢…ë£Œì¼',
      'capclAftDivAmt': 'ìë³¸ê¸ˆì•¡ë©´ê°€ì´í›„ë°°ë‹¹ê¸ˆì•¡',
      'stckParPrcAftDiv': 'ì£¼ì‹ì•¡ë©´ê°€ë°°ë‹¹ì´í›„',
      'clscmpDiviAmt': 'ì •ê¸°ë°°ë‹¹ê¸ˆì•¡',
      'stockCd': 'ì¢…ëª©ì½”ë“œ',
      'stockNm': 'ì¢…ëª©ëª…',
      'clpr': 'ì¢…ê°€',
      'vs': 'ëŒ€ë¹„',
      'fltRt': 'ë“±ë½ë¥ ',
      'mkp': 'ì‹œê°€',
      'hipr': 'ê³ ê°€',
      'lopr': ' lowê°€',
      'trqu': 'ê±°ë˜ëŸ‰',
      'trPrc': 'ê±°ë˜ëŒ€ê¸ˆ',
      'lstgStCnt': 'ìƒì¥ì£¼ì‹ìˆ˜',
      'mrktTotAmt': 'ì‹œê°€ì´ì•¡'
    };

    return columnMap[key] || key;
  }

  // HTML ì´ìŠ¤ì¼€ì´í”„
  function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
  }

  // ë°°ë‹¹ê³µì‹œì •ë³´ ì¡°íšŒ
  async function fetchDividendInfo() {
    const dataEl = document.getElementById('dividend-data');
    dataEl.innerHTML = '<div class="loading">ë°ì´í„°ë¥¼ ê°€ì ¸ì˜¤ëŠ” ì¤‘...</div>';

    try {
      const response = await fetch('/api/disclosure-info?page_no=1&num_of_rows=10');
      const data = await response.json();
      
      if (response.ok) {
        dataEl.innerHTML = jsonToTable(data);
      } else {
        throw new Error(data.error || data.detail || 'ë°ì´í„°ë¥¼ ê°€ì ¸ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
      }
    } catch (error) {
      dataEl.innerHTML = `<div class="error">ì˜¤ë¥˜ ë°œìƒ: ${error.message}</div>`;
    }
  }

  // ë¬´ìƒì¦ì ê³µì‹œì •ë³´ ì¡°íšŒ
  async function fetchBonusIssuanceInfo() {
    const dataEl = document.getElementById('bonus-data');
    dataEl.innerHTML = '<div class="loading">ë°ì´í„°ë¥¼ ê°€ì ¸ì˜¤ëŠ” ì¤‘...</div>';

    try {
      const response = await fetch('/api/bonus-issuance-info?page_no=1&num_of_rows=10');
      const data = await response.json();
      
      if (response.ok) {
        dataEl.innerHTML = jsonToTable(data);
      } else {
        throw new Error(data.error || data.detail || 'ë°ì´í„°ë¥¼ ê°€ì ¸ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
      }
    } catch (error) {
      dataEl.innerHTML = `<div class="error">ì˜¤ë¥˜ ë°œìƒ: ${error.message}</div>`;
    }
  }

  // ì£¼ì‹ì‹œì„¸ì •ë³´ ì¡°íšŒ
  async function fetchStockPrice() {
    const dataEl = document.getElementById('price-data');
    dataEl.innerHTML = '<div class="loading">ë°ì´í„°ë¥¼ ê°€ì ¸ì˜¤ëŠ” ì¤‘...</div>';

    try {
      const response = await fetch('/api/stock-price?page_no=1&num_of_rows=10');
      const data = await response.json();
      
      if (response.ok) {
        dataEl.innerHTML = jsonToTable(data);
      } else {
        throw new Error(data.error || data.detail || 'ë°ì´í„°ë¥¼ ê°€ì ¸ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
      }
    } catch (error) {
      dataEl.innerHTML = `<div class="error">ì˜¤ë¥˜ ë°œìƒ: ${error.message}</div>`;
    }
  }

  // í˜ì´ì§€ ë¡œë“œ ì‹œ ì´ˆê¸° ë°ì´í„° ìë™ ë¡œë“œ
  document.addEventListener('DOMContentLoaded', function() {
    // ì²« ë²ˆì§¸ íƒ­ (ë¬´ìƒì¦ì) ë°ì´í„° ìë™ ë¡œë“œ
    fetchBonusIssuanceInfo();
  });
</script>
{% endblock %}
